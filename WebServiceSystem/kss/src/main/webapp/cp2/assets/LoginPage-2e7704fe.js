import{d as j,u as z,a as oe,r as e,o as W,q as X,b as i,c as re,e as k,f as L,w as o,g as ue,h as E,i as a,j as c,k as A,l as N,t as R,m as H,s as O,n as ne,E as Y,p as ie,v as de,x as pe,y as Z,z as ee,A as ae,B as me,C as ce,D as ve,F as fe,G as ge,H as ye,I as Q,J as we,K as he,L as _e,M as Ve,N as be,O as $e,P as ke,Q as Me,R as qe,_ as Ce}from"./index-b174b04d.js";const Pe={name:"ChangePassword"},Ie=j({...Pe,props:{modelValue:{type:Boolean,required:!0}},emits:{"update:modelValue":null},setup(M,{emit:C}){const{t:U}=z(),r=oe(),n=e({}),g=e(),P=e(),f=e(!1),y=e(!1),_=e(""),V=e();W(async()=>{f.value=!0;try{_.value=await X()}finally{f.value=!1}});const $=()=>{g.value.validate(async t=>{if(t){y.value=!0;try{const d=O(n.value.password,_.value),u=O(n.value.newPassword,_.value),l=await ne({...n.value,password:d,newPassword:u,passwordAgain:void 0});if(l.status!==0){V.value=l.message;return}V.value=void 0,g.value.resetFields(),Y.success(U("success")),C("update:modelValue",!1)}finally{y.value=!1}}})};return(t,d)=>{const u=i("el-alert"),l=i("el-input"),w=i("el-form-item"),I=i("el-button"),S=i("el-form"),b=i("el-dialog"),x=re("loading");return k(),L(b,{title:t.$t("changePassword"),"model-value":M.modelValue,"onUpdate:modelValue":d[4]||(d[4]=p=>t.$emit("update:modelValue",p)),onOpened:d[5]||(d[5]=()=>{var p;(p=P.value)==null||p.focus(),g.value.resetFields()})},{default:o(()=>[ue((k(),L(S,{ref_key:"form",ref:g,model:n.value,"label-width":"150px","label-position":"right"},{default:o(()=>[V.value?(k(),L(u,{key:0,title:V.value,type:"error",class:"mb-3",closable:!1,"show-icon":""},null,8,["title"])):E("",!0),a(w,{prop:"username",label:t.$t("user.username"),rules:[{required:!0,message:()=>t.$t("v.required")}]},{default:o(()=>[a(l,{ref_key:"focus",ref:P,modelValue:n.value.username,"onUpdate:modelValue":d[0]||(d[0]=p=>n.value.username=p),maxlength:"30"},null,8,["modelValue"])]),_:1},8,["label","rules"]),a(w,{prop:"password",label:t.$t("user.origPassword"),rules:[{required:!0,message:()=>t.$t("v.required")}]},{default:o(()=>[a(l,{modelValue:n.value.password,"onUpdate:modelValue":d[1]||(d[1]=p=>n.value.password=p),maxlength:"50","show-password":""},null,8,["modelValue"])]),_:1},8,["label","rules"]),a(w,{prop:"newPassword",label:t.$t("user.newPassword"),rules:[{required:!0,message:()=>t.$t("v.required")},{min:c(r).security.passwordMinLength,max:c(r).security.passwordMaxLength,message:()=>t.$t("user.error.passwordLength",{min:c(r).security.passwordMinLength,max:c(r).security.passwordMaxLength})},{pattern:new RegExp(c(r).security.passwordPattern),message:()=>t.$t(`user.error.passwordPattern.${c(r).security.passwordStrength}`)}]},{default:o(()=>[a(l,{modelValue:n.value.newPassword,"onUpdate:modelValue":d[2]||(d[2]=p=>n.value.newPassword=p),maxlength:c(r).security.passwordMaxLength,"show-password":""},null,8,["modelValue","maxlength"])]),_:1},8,["label","rules"]),a(w,{prop:"passwordAgain",label:t.$t("user.passwordAgain"),rules:[{required:!0,message:()=>t.$t("v.required")},{validator:(p,T,v)=>{if(T!==n.value.newPassword){v(t.$t("user.error.passwordNotMatch"));return}v()}}]},{default:o(()=>[a(l,{modelValue:n.value.passwordAgain,"onUpdate:modelValue":d[3]||(d[3]=p=>n.value.passwordAgain=p),maxlength:"50","show-password":""},null,8,["modelValue"])]),_:1},8,["label","rules"]),A("div",null,[a(I,{loading:y.value,type:"primary","native-type":"submit",onClick:H($,["prevent"])},{default:o(()=>[N(R(t.$t("submit")),1)]),_:1},8,["loading","onClick"])])]),_:1},8,["model"])),[[x,f.value]])]),_:1},8,["title","model-value"])}}}),Se={name:"GetShortMessage"},xe=j({...Se,props:{modelValue:{type:Boolean,required:!0}},emits:{"update:modelValue":null,finish:null},setup(M,{emit:C}){const U=M,{modelValue:r}=ie(U),{t:n}=z(),g=e(),P=e(),f=e({}),y=e(!1),_=e(),V=e(),$=e(),t=async()=>{const{token:u,image:l}=await ae();V.value="data:image/png;base64,"+l,$.value=u};de(r,()=>{r.value&&t()});const d=()=>{g.value.validate(async u=>{var l;if(u){y.value=!0;try{const w=await me((l=$.value)!=null?l:"",f.value.captcha,f.value.mobile,3);if(w.status!==0){_.value=w.message;return}_.value=void 0,g.value.resetFields(),Y.success(n("success")),C("finish",w.result.shortMessageId),C("update:modelValue",!1)}finally{y.value=!1}}})};return(u,l)=>{const w=i("el-alert"),I=i("el-input"),S=i("el-form-item"),b=i("el-image"),x=i("el-button"),p=i("el-form"),T=i("el-dialog");return k(),L(T,{title:u.$t("getShortMessage"),"model-value":M.modelValue,width:"576px","onUpdate:modelValue":l[3]||(l[3]=v=>u.$emit("update:modelValue",v)),onOpened:l[4]||(l[4]=()=>{var v;(v=P.value)==null||v.focus(),g.value.resetFields()})},{default:o(()=>[a(p,{ref_key:"form",ref:g,model:f.value,"label-width":"150px","label-position":"right"},{default:o(()=>[_.value?(k(),L(w,{key:0,title:_.value,type:"error",class:"mb-3",closable:!1,"show-icon":""},null,8,["title"])):E("",!0),a(S,{prop:"mobile",label:u.$t("mobile"),rules:[{required:!0,message:()=>u.$t("v.required")},{asyncValidator:async(v,B,D)=>{if(await c(pe)(B)){D(u.$t("mobileNotExist"));return}D()},trigger:"blur"}]},{default:o(()=>[a(I,{ref_key:"focus",ref:P,modelValue:f.value.mobile,"onUpdate:modelValue":l[0]||(l[0]=v=>f.value.mobile=v),maxlength:"30"},null,8,["modelValue"])]),_:1},8,["label","rules"]),a(S,{prop:"captcha",label:u.$t("captcha"),rules:[{required:!0,message:()=>u.$t("v.required")},{asyncValidator:async(v,B,D)=>{if($.value==null||!await c(Z)($.value,B)){D(u.$t("captchaIncorrect"));return}D()},trigger:"blur"}],class:"captcha"},{default:o(()=>[a(I,{modelValue:f.value.captcha,"onUpdate:modelValue":l[2]||(l[2]=v=>f.value.captcha=v),name:"captcha",placeholder:u.$t("captcha"),"prefix-icon":c(ee)},{append:o(()=>[a(b,{src:V.value,style:{height:"30px","margin-right":"1px"},class:"rounded-r cursor-pointer",title:u.$t("clickToRetrieveCaptcha"),onClick:l[1]||(l[1]=()=>t())},null,8,["src","title"])]),_:1},8,["modelValue","placeholder","prefix-icon"])]),_:1},8,["label","rules"]),A("div",null,[a(x,{loading:y.value,type:"primary","native-type":"submit",onClick:H(d,["prevent"])},{default:o(()=>[N(R(u.$t("submit")),1)]),_:1},8,["loading","onClick"])])]),_:1},8,["model"])]),_:1},8,["title","model-value"])}}}),Le=M=>(Me("data-v-e7152810"),M=M(),qe(),M),De={class:"h-full p-3 bg-gray-100"},Ue={class:"py-5 text-3xl font-bold text-center text-primary"},Te={class:"mt-2 text-right"},Ee={key:0,class:"mt-5 text-sm text-center text-gray-secondary"},Re=Le(()=>A("p",null,"为避免数据被删改，演示用户登录后只拥有浏览后台功能，操作数据会显示无权访问（403）。",-1)),Be=[Re],Ne=j({__name:"LoginPage",setup(M){const{t:C}=z(),U=e(),r=e({}),n=e(),g=e(!1),P=e(!1),f=e(),y=e(),_=e(),V=e(),$=e(!1),t=e(),d=ce(),u=ve(),l="馆控中心",w="production",I=e(!1),S=e(!1),b=e(60),x=e(C("getShortMessage"));fe(),ge();const p=async()=>{const{token:m,image:s}=await ae();f.value="data:image/png;base64,"+s,y.value=m},T=async()=>{g.value=await Ve(),g.value&&p()},v=async()=>{P.value=await be()};W(async()=>{n.value.focus(),n.value.select(),T(),v()}),ye(()=>{t.value=d.query.redirect});const B=m=>{_.value=m,b.value-=1,x.value=String(b.value);const s=setInterval(()=>{b.value-=1,x.value=String(b.value),b.value<=0&&(x.value=C("getShortMessage"),b.value=60,clearInterval(s))},1e3)},D=()=>{U.value.validate(async m=>{if(m){$.value=!0;try{const s=await X(),K=O(r.value.password,s),q=await $e({...r.value,password:K,captchaToken:y.value,shortMessageId:_.value});if(q.status!==0){T(),V.value=q.message;return}q.result.remainingDays!=null&&ke.alert(C("passwordRemaingDays",{remainingDays:q.result.remainingDays}),{type:"warning"}),t.value?u.push(t.value):window.location.reload()}finally{$.value=!1}}})};return(m,s)=>{const K=i("el-alert"),q=i("el-input"),F=i("el-form-item"),G=i("el-button"),le=i("el-image"),se=i("el-form");return k(),Q("div",De,[A("h3",Ue,R(c(l)),1),a(se,{ref_key:"form",ref:U,model:r.value,class:"mx-auto md:max-w-xs"},{default:o(()=>[V.value?(k(),L(K,{key:0,title:V.value,type:"error",class:"mb-3",closable:!1,"show-icon":""},null,8,["title"])):E("",!0),a(F,{prop:"username",rules:[{required:!0,message:()=>m.$t("v.required")}]},{default:o(()=>[a(q,{ref_key:"focus",ref:n,modelValue:r.value.username,"onUpdate:modelValue":s[0]||(s[0]=h=>r.value.username=h),name:"username",placeholder:m.$t("username"),"prefix-icon":c(we),autocomplete:"on"},null,8,["modelValue","placeholder","prefix-icon"])]),_:1},8,["rules"]),a(F,{prop:"password",rules:[{required:!0,message:()=>m.$t("v.required")}]},{default:o(()=>[a(q,{ref:"password",modelValue:r.value.password,"onUpdate:modelValue":s[1]||(s[1]=h=>r.value.password=h),type:"password",name:"password",placeholder:m.$t("password"),"prefix-icon":c(he),"show-password":""},null,8,["modelValue","placeholder","prefix-icon"])]),_:1},8,["rules"]),P.value?(k(),L(F,{key:1,prop:"shortMessageValue",rules:[{required:!0,message:()=>m.$t("v.required")}]},{default:o(()=>[a(q,{modelValue:r.value.shortMessageValue,"onUpdate:modelValue":s[3]||(s[3]=h=>r.value.shortMessageValue=h),name:"shortMessageValue",placeholder:m.$t("shortMessage"),"prefix-icon":c(_e)},{append:o(()=>[a(G,{disabled:b.value<60,onClick:s[2]||(s[2]=()=>S.value=!0)},{default:o(()=>[N(R(x.value),1)]),_:1},8,["disabled"])]),_:1},8,["modelValue","placeholder","prefix-icon"])]),_:1},8,["rules"])):E("",!0),g.value?(k(),L(F,{key:2,prop:"captcha",rules:[{required:!0,message:()=>m.$t("v.required")},{asyncValidator:async(h,te,J)=>{if(y.value==null||!await c(Z)(y.value,te)){J(m.$t("captchaIncorrect"));return}J()},trigger:"blur"}],class:"captcha"},{default:o(()=>[a(q,{modelValue:r.value.captcha,"onUpdate:modelValue":s[5]||(s[5]=h=>r.value.captcha=h),name:"captcha",placeholder:m.$t("captcha"),"prefix-icon":c(ee)},{append:o(()=>[a(le,{src:f.value,style:{height:"30px","margin-right":"1px"},class:"rounded-r cursor-pointer",title:m.$t("clickToRetrieveCaptcha"),onClick:s[4]||(s[4]=()=>p())},null,8,["src","title"])]),_:1},8,["modelValue","placeholder","prefix-icon"])]),_:1},8,["rules"])):E("",!0),a(G,{type:"primary","native-type":"submit",class:"w-full",loading:$.value,onClick:H(D,["prevent"])},{default:o(()=>[N(R(m.$t("login")),1)]),_:1},8,["loading","onClick"]),A("div",Te,[a(G,{type:"primary",link:"",onClick:s[6]||(s[6]=()=>I.value=!0)},{default:o(()=>[N(R(m.$t("changePassword")),1)]),_:1})])]),_:1},8,["model"]),c(w)==="staging"?(k(),Q("div",Ee,Be)):E("",!0),a(Ie,{modelValue:I.value,"onUpdate:modelValue":s[7]||(s[7]=h=>I.value=h)},null,8,["modelValue"]),a(xe,{modelValue:S.value,"onUpdate:modelValue":s[8]||(s[8]=h=>S.value=h),onFinish:B},null,8,["modelValue"])])}}});const Fe=Ce(Ne,[["__scopeId","data-v-e7152810"]]);export{Fe as default};
